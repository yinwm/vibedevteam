# STORY-002：任务调度闭环

> **文档路径**：`/docs/E-001-Agent-Console/story/STORY-002-任务调度闭环.md`
>
> * **STORY ID**：STORY-002
> * **EPIC_ID**：E-001
> * **EPIC_DIR**：`E-001-Agent-Console`
> * **关联 PRD**：`../prd/PRD-E-001-v0.md#场景2-分派新任务`
> * **状态**：待开发
> * **优先级**：P1（高）
> * **创建人**：prd agent
> * **创建日期**：2026-01-20
> * **预计完成**：[OPEN]

---

## 1. User Story 文本

**作为一个** 开发者（用户自己）

**我想要** 快速将任务分派给空闲的 Agent，并立即开始执行

**以便于** 我能在 30 秒内完成"选任务 → 选人 → 确认"，不需要在终端间切换或手动输入长指令

---

## 2. 背景与动机

### 2.1 痛点（来自 PRD 场景 2）

**P1：认知过载**
- 之前需要在终端里找对应的 dev（切终端、找对话、确认状态、发指令）
- 当前成本：约 30-60 秒才能完成一次任务分派
- 操作步骤：6-8 步（打开终端 → 找到对话 → 输入指令 → 发送 → 确认）

**P2：记忆负担**
- 需要记住哪个 dev 是后端、哪个 dev 是前端
- 需要记住每个 dev 的当前状态（忙碌/空闲）

### 2.2 当前成本

- **时间成本**：30-60 秒完成一次任务分派
- **认知负荷**：需要记住 4 个 dev 的角色和状态
- **操作步骤**：6-8 步（切终端、找对话、输入指令、发送）

### 2.3 预期价值

- ✅ 分派任务时间：从 30-60 秒 → < 30 秒
- ✅ 操作步骤：从 6-8 步 → 3 步（选任务、选人、确认）
- ✅ 终端切换次数：从 2-3 次 → 0 次
- ✅ 记忆负担：从"记 dev 角色" → 屏幕可见

---

## 3. 主要使用场景（主路径步骤）

### 3.1 场景：从"手忙脚乱"到"一键搞定"

**触发条件**：下午 14:30，发现新任务 TASK-03（用户登录 API）已经可以开始了

**主路径**：

1. **用户在知识图谱树中选中 TASK-03**
   - 系统高亮显示依赖路径：EPIC-001 → PRD-v1 → STORY-101 → TASK-03
   - **成功标志**：依赖路径用黄色虚线高亮显示

2. **用户在员工档案中选中空闲的 Dave-1**
   - 系统显示"分派任务"按钮（只有空闲 Agent 才显示）
   - **成功标志**：能看到 Dave-1（绿色空闲）、Dave-2（绿色空闲）

3. **用户点击"分派任务"按钮**
   - 讨论室自动切换到 Dave-1 的 tab
   - 输入框自动填充任务描述："领 TASK-03，开始实现用户登录 API"
   - **成功标志**：讨论室切换完成，输入框已填充

4. **用户点击"发送"按钮**
   - 消息发送给 Dave-1
   - Dave-1 开始执行任务
   - **成功标志**：消息显示在对话历史中

5. **Dave-1 开始执行**
   - 员工档案中 Dave-1 状态变为"忙碌"（蓝色）
   - 运行终端显示 Dave-1 的实时日志
   - **成功标志**：状态实时更新，日志开始输出

**完成标志**：从"发现任务"到"开始执行"，只花了 30 秒

---

## 4. 状态机（关键状态与跃迁）

### 4.1 任务分派的状态机

```
┌──────────┐  选中TASK  ┌──────────┐  选中Agent  ┌──────────┐
│  初始态   │ ────────> │  选择态   │ ─────────> │  确认态   │
│ (浏览图谱) │           │(高亮路径) │            │(填充输入) │
└──────────┘           └──────────┘            └──────────┘
                                                  │
                                                  │ 点击发送
                                                  ▼
                                          ┌──────────┐
                                          │  执行态   │
                                          │(Agent工作) │
                                          └──────────┘
```

**关键跃迁**：
- **初始态 → 选择态**：用户在知识图谱树中选中一个 TASK
- **选择态 → 确认态**：用户在员工档案中选中一个空闲的 Agent
- **确认态 → 执行态**：用户点击"发送"，Agent 开始执行任务

**恢复路径**：
- 如果选中的 Agent 忙碌 → 显示"Agent 忙碌"提示，回到选择态
- 如果 Agent 已释放 → 提示"Agent 已释放，是否自动启动？"
- 如果任务已分派 → 显示警告"任务已分派给其他 Agent"

### 4.2 讨论室 Tab 的状态机

```
┌──────────┐  创建tab  ┌──────────┐  发送消息  ┌──────────┐
│  空态     │ ────────> │  对话态   │ ─────────> │  等待态   │
│ (无tab)   │           │(多tab)   │            │(思考中)  │
└──────────┘           └──────────┘            └──────────┘
                                                  │
                                                  │ 收到回复
                                                  ▼
                                          ┌──────────┐
                                          │  完成态   │
                                          │(显示回复) │
                                          └──────────┘
```

**关键跃迁**：
- **空态 → 对话态**：用户创建新的 tab，选择 Agent
- **对话态 → 等待态**：用户发送消息，Agent 正在思考
- **等待态 → 完成态**：Agent 回复，显示在对话历史中

**恢复路径**：
- 如果 Agent 无响应 → 显示"连接超时，请重试"错误
- 如果用户关闭 tab → 对话历史保存到 JSONL 文件

---

## 5. 验收标准（Acceptance Criteria）

### AC1：用户能在知识图谱中选中 TASK，高亮依赖路径

**步骤**：
1. 用户打开应用
2. 在知识图谱树中找到 TASK-03
3. 点击 TASK-03 节点
4. 观察高亮显示的依赖路径

**期望结果**：
- ✅ 依赖路径用黄色虚线高亮显示
- ✅ 路径清晰可读：EPIC → PRD → STORY → TASK
- ✅ 每个节点的状态用颜色标识
- ✅ 高亮响应时间 < 500ms

**测试数据**：使用 `docs/E-001-xxx/` 下的真实 TASK 文档

---

### AC2：用户能在员工档案中选中空闲 Agent，显示"分派任务"按钮

**步骤**：
1. 用户在知识图谱树中选中 TASK-03
2. 观察员工档案中的 Agent 卡片
3. 点击 Dave-1 的卡片（假设 Dave-1 空闲）
4. 观察"分派任务"按钮

**期望结果**：
- ✅ 空闲 Agent 的卡片显示"分派任务"按钮
- ✅ 忙碌 Agent 的卡片不显示"分派任务"按钮（显示"忙碌中"）
- ✅ 已释放 Agent 的卡片显示"启动并分派"按钮
- ✅ 点击按钮后，讨论室自动切换到对应 Agent 的 tab

**测试方式**：手工测试不同状态的 Agent

---

### AC3：用户点击"分派任务"后，讨论室自动切换并填充任务描述

**步骤**：
1. 用户在知识图谱树中选中 TASK-03
2. 用户在员工档案中选中 Dave-1
3. 用户点击"分派任务"按钮
4. 观察讨论室的 tab 和输入框

**期望结果**：
- ✅ 讨论室自动切换到 Dave-1 的 tab（如果不存在则自动创建）
- ✅ 输入框自动填充任务描述："领 TASK-03，开始实现用户登录 API"
- ✅ 任务描述从 TASK 文档的 Frontmatter 或内容中提取
- ✅ 输入框获得焦点，用户可以直接点击"发送"
- ✅ 整个流程 < 2 秒

**测试数据**：使用 `docs/E-001-xxx/task/TASK-003.md` 的真实内容

---

### AC4：用户点击"发送"后，Agent 开始执行，状态实时更新

**步骤**：
1. 用户点击"发送"按钮
2. 观察讨论室的对话历史
3. 观察员工档案中 Dave-1 的状态
4. 观察运行终端的日志流

**期望结果**：
- ✅ 消息显示在对话历史中（发送者：用户，内容：任务描述）
- ✅ Agent 在 5 秒内回复（如"好的，开始实现 TASK-03"）
- ✅ 员工档案中 Dave-1 状态从"空闲"（绿色）→ "忙碌"（蓝色）
- ✅ 运行终端显示 Dave-1 的实时日志（如 `> cargo test --lib`）
- ✅ 状态更新延迟 < 1 秒

**测试方式**：手工测试 + 计时

---

### AC5：用户能在 30 秒内完成"选任务 → 选人 → 确认"

**步骤**：
1. 用户发现新任务 TASK-03（TODO 状态）
2. 计时开始
3. 用户在知识图谱树中选中 TASK-03
4. 用户在员工档案中选中 Dave-1
5. 用户点击"分派任务"按钮
6. 用户点击"发送"按钮
7. 计时结束

**期望结果**：
- ✅ 整个流程 < 30 秒
- ✅ 用户不需要切换到终端
- ✅ 用户不需要手动输入任务描述
- ✅ Agent 正确接收到任务并开始执行

**测试方式**：用户测试 + 计时

---

### AC6：系统能检测 Agent 忙碌状态，防止重复分派

**步骤**：
1. 用户选中 TASK-03
2. 用户选中忙碌的 Agent（假设 Dave-1 正在执行 TASK-01）
3. 用户点击"分派任务"按钮

**期望结果**：
- ✅ 显示"Dave-1 正在执行 TASK-01，是否等待？"
- ✅ 提示中显示 Dave-1 当前正在执行的任务（TASK-01）
- ✅ 提供 3 个选项：
  - 选项 A："等待"（加入队列，显示预计等待时间）
  - 选项 B："选其他人"（高亮显示其他空闲的 Agent）
  - 选项 C："强制中断"（提示：中断后需要手动恢复）
- ✅ 任务不会分派给忙碌的 Agent

**测试方式**：手工测试忙碌状态的 Agent

---

## 6. 边界与异常

### 6.1 Agent 忙碌（重复分派）

**场景**：用户试图给正在执行任务的 Agent 分派新任务

**错误提示**：显示"Dave-1 正在执行 TASK-01，是否等待？"

**恢复路径**：
- **选项 A**："等待"（加入队列，显示预计等待时间）
  - 系统将任务加入队列
  - 显示"当前任务预计 5 分钟后完成"
- **选项 B**："选其他人"（高亮显示其他空闲的 dev）
  - 系统高亮显示其他空闲的 Agent（如 Dave-2）
- **选项 C**："强制中断"（提示：中断后需要手动恢复）
  - 显示警告：中断后 TASK-01 的进度会丢失
  - 用户确认后，中断 TASK-01，开始新任务

**验收标准**：
- ✅ 不会重复分派任务给同一个 Agent
- ✅ 提示信息清晰，用户知道后果

---

### 6.2 Agent 已释放

**场景**：用户试图给已释放的 Agent 分派任务

**提示**：显示"Dave-1 已释放，是否自动启动？"

**恢复路径**：
- **选项 A**："自动启动并分派"（推荐）
  - 系统自动启动 Dave-1 的进程
  - 从 JSONL 文件恢复对话历史
  - 分派新任务
- **选项 B**："先启动，稍后分派"
  - 系统启动 Dave-1 的进程
  - 不分派任务，等待用户手动操作

**验收标准**：
- ✅ Agent 自动启动成功
- ✅ Session 恢复成功率 > 95%
- ✅ 启动时间 < 3 秒

---

### 6.3 任务已分派

**场景**：任务已经分派给其他 Agent

**警告**：显示"TASK-03 已分派给 Dave-2，是否重新分派？"

**恢复路径**：
- 显示当前执行状态（进度、日志链接）
- **选项 A**："重新分派"（中断 Dave-2）
  - 显示警告：中断后 Dave-2 的进度会丢失
  - 用户确认后，中断 Dave-2，分派给新 Agent
- **选项 B**："取消"（回到之前的任务）
  - 取消当前操作，回到分派前的状态

**验收标准**：
- ✅ 不会重复分派同一个任务
- ✅ 提示信息清晰，显示当前执行状态

---

### 6.4 Agent 无响应

**场景**：用户发送消息后，Agent 5 秒内没有回复

**错误提示**：显示"Agent 无响应，请重试"

**恢复路径**：
- 提供"重新启动"按钮
- 提供"查看日志"按钮（跳转到运行终端）
- 提供"取消任务"按钮

**验收标准**：
- ✅ 错误提示在 5 秒后显示（避免用户等待太久）
- ✅ 提供清晰的恢复路径

---

### 6.5 讨论室 Tab 超过限制

**场景**：用户尝试创建第 11 个 tab

**错误提示**：显示"最多同时打开 10 个 tab"

**恢复路径**：
- 提供"关闭最少使用的 tab"按钮
- 提供"取消"按钮

**验收标准**：
- ✅ 不会创建超过 10 个 tab
- ✅ 提示信息清晰，提供解决方案

---

### 6.6 任务描述提取失败

**场景**：系统无法从 TASK 文档提取任务描述

**降级方案**：
- 输入框填充通用描述："领 TASK-03，请查看文档了解详情"
- 提供"从 TASK 文档加载"按钮（用户手动点击后重新尝试）

**验收标准**：
- ✅ 不会因为提取失败而阻塞流程
- ✅ 提供手动补救方案

---

## 7. 接口契约草案（Interface Contract Draft）

> **说明**：本章节用自然语言描述接口的业务字段含义和边界条件。

### 7.1 前端 → Rust：启动 Agent

**触发时机**：用户点击"分派任务"按钮，但 Agent 已释放

**请求结构**（前端 → Rust，通过 Tauri Command）：
```yaml
command_name: "start_agent"

request:
  agent_id: "dave-1"
  restore_session: true                      # 是否从 JSONL 恢复对话历史
  session_path: "/sessions/dave-1.jsonl"    # Session 文件路径

response:
  success: true
  process_id: 12345                         # Agent 进程 ID
  session_restored: true                    # Session 是否恢复成功
  error_message: null                       # 失败时显示错误信息
```

**边界条件**：
- **Agent 已运行**：返回 `success: false, error_message: "Agent 已在运行"`
- **Session 文件不存在**：返回 `session_restored: false`，但不影响启动
- **Session 文件损坏**：返回 `session_restored: false, error_message: "Session 损坏，将启动新 Session"`

**性能要求**：
- 启动时间 < 3 秒（从点击到 Agent 可用）

---

### 7.2 前端 → Rust：发送消息给 Agent

**触发时机**：用户点击"发送"按钮

**请求结构**（前端 → Rust，通过 Tauri Command）：
```yaml
command_name: "send_message_to_agent"

request:
  agent_id: "dave-1"
  message: "领 TASK-03，开始实现用户登录 API"
  task_id: "TASK-03"                        # 可选：关联的 TASK ID
  save_to_history: true                     # 是否保存到对话历史

response:
  success: true
  message_id: "msg-001"                     # 消息唯一标识
  timestamp: "2026-01-20T14:30:00Z"
  error_message: null
```

**边界条件**：
- **Agent 未运行**：返回 `success: false, error_message: "Agent 未运行"`
- **message 为空**：返回 `success: false, error_message: "消息不能为空"`
- **message 超长**（> 10000 字符）：返回 `success: false, error_message: "消息过长"`

**性能要求**：
- 响应时间 < 500ms（从点击到消息发送成功）

---

### 7.3 Rust → 前端：Agent 回复推送

**触发时机**：Agent 回复消息

**请求结构**（Rust → 前端，通过 Tauri Event）：
```yaml
event_name: "agent:reply_received"

payload:
  agent_id: "dave-1"
  message_id: "msg-001"                     # 对应的消息 ID
  reply: "好的，开始实现 TASK-03。首先检查 PRD 中的需求..."
  timestamp: "2026-01-20T14:30:05Z"
  tools_called:                             # Agent 调用的工具（可选）
    - name: "read_file"
      args:
        file_path: "/docs/E-001-xxx/prd/PRD-E-001-v0.md"
      result: "success"
```

**边界条件**：
- **回复为空**：返回 `reply: ""`，前端显示"Agent 无回复"
- **回复超长**（> 10000 字符）：截断前 1000 字符，显示"查看完整回复"按钮

**性能要求**：
- 推送延迟 < 1 秒（从 Agent 回复到前端收到）

---

### 7.4 前端 → Rust：提取任务描述

**触发时机**：用户点击"分派任务"按钮

**请求结构**（前端 → Rust，通过 Tauri Command）：
```yaml
command_name: "extract_task_description"

request:
  task_id: "TASK-03"
  task_path: "/docs/E-001-xxx/task/TASK-003.md"  # TASK 文档路径

response:
  success: true
  description: "实现用户登录 API，包括注册、登录、登出功能"  # 提取的任务描述
  summary: "用户登录 API 实现"                # 简短摘要（用于输入框）
  error_message: null
```

**边界条件**：
- **TASK 文档不存在**：返回 `success: false, error_message: "TASK 文档不存在"`
- **无法提取描述**：返回 `success: true, description: ""`，使用默认描述
- **描述过长**（> 500 字符）：返回前 500 字符 + "..."

**性能要求**：
- 响应时间 < 500ms（从点击到提取完成）

---

### 7.5 前端 → Rust：检查 Agent 是否忙碌

**触发时机**：用户在员工档案中选中 Agent

**请求结构**（前端 → Rust，通过 Tauri Command）：
```yaml
command_name: "check_agent_status"

request:
  agent_id: "dave-1"

response:
  success: true
  is_busy: true                              # 是否忙碌
  current_task:                              # 当前任务（如果忙碌）
    task_id: "TASK-01"
    task_name: "数据库设计"
    started_at: "2026-01-20T10:00:00Z"
    progress: 60                             # 进度百分比（可选）
  estimated_completion: "2026-01-20T11:00:00Z"  # 预计完成时间（可选）
  error_message: null
```

**边界条件**：
- **Agent 未运行**：返回 `is_busy: false, current_task: null`
- **Agent 已释放**：返回 `is_busy: false, current_task: null`
- **无法获取状态**：返回 `success: false, error_message: "无法获取 Agent 状态"`

**性能要求**：
- 响应时间 < 300ms（从点击到显示状态）

---

### 7.6 Rust → 前端：Agent 状态变更推送

**触发时机**：Agent 状态变化（如从 IDLE → BUSY）

**请求结构**（Rust → 前端，通过 Tauri Event）：
```yaml
event_name: "agent:status_changed"

payload:
  agent_id: "dave-1"
  old_status: "IDLE"
  new_status: "BUSY"
  task_id: "TASK-03"                         # 关联的任务 ID（如果适用）
  timestamp: "2026-01-20T14:30:00Z"
```

**边界条件**：
- **状态不变**：不推送事件（避免冗余）
- **状态转换非法**（如从 BUSY → RELEASED）：记录错误日志

**性能要求**：
- 推送延迟 < 500ms（从状态变化到前端收到）

---

## 8. UI 证据引用

### 8.1 原型链接

**可运行 HTML 原型**：`/docs/E-001-Agent-Console/prototypes/index.html`

### 8.2 关键页面截图

#### 讨论室界面

```
┌─────────────────────────────────────────────────────────┐
│ [Tiger 🟢] [Dave-1 🔵] [Dave-2 ⚪] [Terry ⚪] [+]      │
├─────────────────────────────────────────────────────────┤
│  我: 领 TASK-03，开始实现用户登录 API                     │
│                                                          │
│  Dave-1: 好的，开始实现 TASK-03。首先检查 PRD 中的需求... │
│                                                          │
│  [在此输入消息...]                     [发送]            │
└─────────────────────────────────────────────────────────┘
```

#### 分派任务对话框

```
┌─────────────────────────────────────────────────────────┐
│  分派任务：TASK-03 → Dave-1                             │
├─────────────────────────────────────────────────────────┤
│  任务描述：                                              │
│  领 TASK-03，开始实现用户登录 API                         │
│                                                          │
│  [取消]                    [确认分派]                    │
└─────────────────────────────────────────────────────────┘
```

#### Agent 忙碌提示

```
┌─────────────────────────────────────────────────────────┐
│  ⚠️  Dave-1 正在执行 TASK-01                             │
│                                                          │
│  当前任务：数据库设计                                     │
│  预计完成：5 分钟后                                       │
│                                                          │
│  [等待] [选其他人] [强制中断]                             │
└─────────────────────────────────────────────────────────┘
```

---

## 9. 依赖与备注

### 9.1 技术依赖

**前端技术栈**：
- React 18+ + TypeScript 5+
- Zustand（状态管理）
- TailwindCSS + Shadcn/UI（UI 组件库）

**Rust 技术栈**：
- Tauri v2（桌面框架）
- std::process（进程管理）

**外部依赖**：
- Agent 进程：Claude Code（`claude -p --input-format=stream-json --output-format=stream-json --agent <agent>`）
- Session 格式：JSONL（JSON Lines）

---

### 9.2 STORY 依赖

**前置 STORY**：
- **STORY-001（全局状态可视化）**：依赖知识图谱树和员工档案

**后续 STORY**：
- **STORY-003（实时进度监控）**：依赖本 STORY 的 Agent 启动和消息发送
- **STORY-004（自动资源管理）**：依赖本 STORY 的 Agent 状态管理

---

### 9.3 数据依赖

**对话历史格式**（JSONL）：
```json
{"timestamp": "2026-01-20T14:30:00Z", "role": "user", "content": "领 TASK-03，开始实现用户登录 API"}
{"timestamp": "2026-01-20T14:30:05Z", "role": "assistant", "content": "好的，开始实现 TASK-03。首先检查 PRD 中的需求..."}
```

**TASK 文档格式**（Frontmatter）：
```yaml
---
id: "TASK-03"
title: "用户登录 API 实现"
status: "TODO"
description: "实现用户登录 API，包括注册、登录、登出功能"
---
```

---

### 9.4 风险与未决项

**[OPEN-1] Session 恢复成功率**
- **问题**：JSONL 文件损坏时，如何恢复对话历史？
- **建议**：Phase 1 先提供"手动修复"工具，Phase 2 再考虑自动修复
- **责任方**：tech

**[OPEN-2] 消息发送超时时间**
- **问题**：Agent 多久没回复算"无响应"？
- **建议**：设置为 5 秒（基于 Claude Code 的平均响应时间）
- **责任方**：prd + tech

**[OPEN-3] 任务描述提取算法**
- **问题**：如何从 TASK 文档提取任务描述？
- **建议**：优先使用 Frontmatter 的 `description` 字段，如果为空，则提取第一段正文
- **责任方**：tech

---

### 9.5 非目标（Out of Scope）

本 STORY **不包含**：
- ❌ 自动任务调度（L2 级别）：属于 Phase 2
- ❌ Agent 之间自主协商（L3 级别）：属于 Phase 3
- ❌ 运行终端（F3）：属于 STORY-003
- ❌ 进程自动释放（F4）：属于 STORY-004

---

## 10. 验收总结

### 10.1 核心验收点

| 验收点 | 验收方式 | 目标值 |
|-------|---------|-------|
| **分派任务时间** | 计时测试 | < 30 秒 |
| **操作步骤** | 计数 | 3 步（选任务、选人、确认） |
| **终端切换次数** | 计数 | 0 次 |
| **Agent 响应时间** | 计时测试 | < 5 秒 |
| **状态更新延迟** | 计时测试 | < 1 秒 |

### 10.2 质量门槛

- ✅ 代码清晰：遵守 YAGNI 和 KISS 原则
- ✅ 测试覆盖率：核心业务逻辑 50%

### 10.3 用户体验北极星验证

**体验北极星**：从"手忙脚乱"到"一键搞定"

**验证方式**：
- ✅ 用户能在 30 秒内完成"选任务 → 选人 → 确认"
- ✅ 用户不需要切换到终端
- ✅ 用户不需要手动输入长指令
- ✅ 系统能检测 Agent 忙碌状态，防止重复分派

---

## 11. 变更记录

| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|----------|
| v0.1 | 2026-01-20 | prd agent | 初版 STORY-002，基于 PRD 场景 2 |

---

## 附录：参考文档

- **PRD**：`/docs/E-001-Agent-Console/prd/PRD-E-001-v0.md`
- **Tech Baseline**：`/docs/_project/tech-baseline.md`
- **STORY-001**：`/docs/E-001-Agent-Console/story/STORY-001-全局状态可视化.md`
- **UI 原型**：`/docs/E-001-Agent-Console/prototypes/index.html`
