# STORY-003：实时进度监控

> **文档路径**：`/docs/E-001-Agent-Console/story/STORY-003-实时进度监控.md`
>
> * **STORY ID**：STORY-003
> * **EPIC_ID**：E-001
> * **EPIC_DIR**：`E-001-Agent-Console`
> * **关联 PRD**：`../prd/PRD-E-001-v0.md#场景3-查看执行进度`
> * **状态**：待开发
> * **优先级**：P1（高）
> * **创建日期**：2026-01-20
> * **预计完成**：[OPEN]

---

## 1. User Story 文本

**作为一个** 开发者（用户自己）

**我想要** 实时看到 Agent 的执行进度和日志，不需要频繁切终端

**以便于** 我能在 10 秒内发现错误，并一键询问 Agent，从"盲目等待"到"实时掌控"

---

## 2. 背景与动机

### 2.1 痛点（来自 PRD 场景 3）

**P1：认知过载**
- 之前得盯着终端窗口，错过日志就麻烦了
- 需要频繁切终端，担心错过重要日志
- 当前成本：每分钟切 2-3 次终端，平均错误发现时间 2-5 分钟

**P2：效率低下**
- 发现错误后，需要复制错误信息，切到对话窗口，粘贴询问
- 当前成本：30-60 秒才能询问 Agent 关于错误的问题

### 2.2 当前成本

- **时间成本**：平均错误发现时间 2-5 分钟
- **认知负荷**：需要频繁切终端，担心错过重要日志
- **操作步骤**：复制错误 + 切窗口 + 粘贴 + 发送（4 步）

### 2.3 预期价值

- ✅ 错误发现时间：从 2-5 分钟 → < 10 秒（自动高亮）
- ✅ 询问 Agent 时间：从 30-60 秒 → < 10 秒（一键询问）
- ✅ 日志查看频率：从每分钟切 2-3 次终端 → 扫一眼屏幕即可
- ✅ 日志刷新延迟：< 1 秒（实时流式输出）

---

## 3. 主要使用场景（主路径步骤）

### 3.1 场景：从"盲目等待"到"实时掌控"

**触发条件**：下午 15:00，刚给 Dave-1 分派了 TASK-03，需要等待完成

**主路径**：

1. **用户扫一眼运行终端**
   - 看到所有 Agent 的执行进度和实时日志
   - **成功标志**：能看到 Dave-1 的面板，显示实时日志流

2. **用户观察日志流**
   - 实时日志流：`[INFO] > cargo test --lib`
   - 进度条：`[=========>     ] 60%`
   - 状态："正在执行单元测试"
   - **成功标志**：日志实时刷新（延迟 < 1 秒）

3. **用户发现错误日志**
   - 看到红色高亮的错误日志：`[ERROR] error: test failed at line 123`
   - **成功标志**：错误日志自动红色高亮，一眼就能看到

4. **用户点击"询问 Agent"按钮**
   - 自动切换到讨论室的 Dave-1 tab
   - 输入框自动填充："测试失败了，怎么回事？"
   - **成功标志**：讨论室切换完成，输入框已填充

5. **Agent 分析错误**
   - Dave-1 分析日志，给出修复建议或直接修复
   - **成功标志**：Agent 回复包含修复建议

**完成标志**：从"发现错误"到"询问 Agent"，只花了 10 秒

---

## 4. 状态机（关键状态与跃迁）

### 4.1 运行终端的状态机

```
┌──────────┐  Agent启动  ┌──────────┐  日志输出  ┌──────────┐
│  空态     │ ────────> │  运行态   │ ────────> │  更新态   │
│ (无Agent) │           │(显示日志) │           │(追加日志) │
└──────────┘           └──────────┘           └──────────┘
                                                  │
                                                  │ 检测到错误
                                                  ▼
                                          ┌──────────┐
                                          │  错误态   │
                                          │(高亮显示) │
                                          └──────────┘
```

**关键跃迁**：
- **空态 → 运行态**：Agent 启动，创建新的终端面板
- **运行态 → 更新态**：Agent 输出日志，实时追加到终端面板
- **更新态 → 错误态**：检测到错误日志（`[ERROR]`），自动高亮显示

**恢复路径**：
- 如果 Agent 崩溃 → 进入"崩溃态"（显示"Agent 进程异常退出"）
- 如果用户点击"重新启动" → 重新进入运行态
- 如果日志超过 1000 行 → 自动清理旧日志，保留最新 1000 行

### 4.2 日志流的状态机

```
┌──────────┐  启动Agent  ┌──────────┐  输出日志  ┌──────────┐
│  空闲态   │ ─────────> │  活跃态   │ ─────────> │  流式态   │
│ (无输出)  │            │(启动中)  │            │(实时输出) │
└──────────┘            └──────────┘            └──────────┘
                                                  │
                                                  │ 暂停日志
                                                  ▼
                                          ┌──────────┐
                                          │  暂停态   │
                                          │(停止更新) │
                                          └──────────┘
```

**关键跃迁**：
- **空闲态 → 活跃态**：Agent 进程启动
- **活跃态 → 流式态**：开始输出日志（stream-json 格式）
- **流式态 → 暂停态**：用户点击"暂停日志流"按钮

**恢复路径**：
- 如果用户点击"继续" → 回到流式态
- 如果 Agent 完成 → 回到空闲态

---

## 5. 验收标准（Acceptance Criteria）

### AC1：用户能实时看到 Agent 的日志输出

**步骤**：
1. 用户在运行终端中找到 Dave-1 的面板
2. 用户在讨论室中让 Dave-1 执行任务（如 `cargo test`）
3. 用户观察日志流

**期望结果**：
- ✅ 日志实时刷新（延迟 < 1 秒）
- ✅ 日志内容正确显示（包括时间戳、日志级别、日志内容）
- ✅ 日志级别用颜色标识（INFO 白色、WARN 黄色、ERROR 红色）
- ✅ 日志自动滚动到最新一行

**测试方式**：手工测试 + 计时

---

### AC2：错误日志自动红色高亮

**步骤**：
1. 用户让 Dave-1 执行一个会失败的任务（如 `cargo test`，故意让测试失败）
2. 用户观察日志流

**期望结果**：
- ✅ 错误日志（`[ERROR]`）自动红色高亮
- ✅ 错误日志在视觉上非常明显（粗体 + 红色背景）
- ✅ 其他日志不受影响
- ✅ 高亮响应时间 < 100ms

**测试方式**：手工测试 + 故意注入错误

---

### AC3：用户能搜索日志，快速定位错误信息

**步骤**：
1. 用户在运行终端的搜索框中输入关键词（如 "error"）
2. 用户观察搜索结果

**期望结果**：
- ✅ 搜索结果高亮显示（黄色背景）
- ✅ 提供"上一个"/"下一个"按钮，快速跳转到匹配项
- ✅ 搜索响应时间 < 500ms（1000 行日志）
- ✅ 支持正则表达式（可选）

**测试方式**：手工测试 + 性能测试

---

### AC4：用户能清空日志，释放内存

**步骤**：
1. 用户在运行终端中找到 Dave-1 的面板
2. 用户点击"清空日志"按钮

**期望结果**：
- ✅ 日志面板清空，只保留最后一条提示："日志已清空"
- ✅ 内存释放（通过任务管理器验证）
- ✅ 不影响 Agent 的执行
- ✅ 后续日志继续正常显示

**测试方式**：手工测试 + 内存监控

---

### AC5：用户能一键询问 Agent 关于错误的问题

**步骤**：
1. 用户在运行终端中看到红色高亮的错误日志
2. 用户点击"询问 Agent"按钮
3. 用户观察讨论室

**期望结果**：
- ✅ 讨论室自动切换到对应 Agent 的 tab（如 Dave-1）
- ✅ 输入框自动填充："测试失败了，怎么回事？"
- ✅ 输入框自动填充错误日志内容（或错误摘要）
- ✅ 整个流程 < 2 秒
- ✅ Agent 回复包含修复建议

**测试方式**：手工测试 + 计时

---

### AC6：日志超过 1000 行时，自动清理旧日志

**步骤**：
1. 用户让 Agent 输出超过 1000 行日志（如运行一个长时间的测试）
2. 用户观察日志面板

**期望结果**：
- ✅ 日志面板只保留最新 1000 行
- ✅ 旧日志被自动清理（不占用内存）
- ✅ 日志面板顶部显示提示："已清理旧日志，保留最新 1000 行"
- ✅ 清理过程不影响日志的实时显示

**测试方式**：手工测试 + 内存监控

---

## 6. 边界与异常

### 6.1 空态（没有 Agent 在运行）

**场景**：用户刚打开应用，还没有启动任何 Agent

**空态表现**：
- 显示"暂无活跃 Agent"提示
- 提供"启动 Agent"按钮（链接到员工档案）

**验收标准**：
- ✅ 空态提示文案清晰，用户知道下一步该做什么
- ✅ 空态不影响应用的稳定性

---

### 6.2 Agent 崩溃（进程异常退出）

**场景**：Agent 进程因为错误而崩溃（如 segmentation fault）

**错误提示**：显示"Agent 进程异常退出"

**恢复路径**：
- 提供"重新启动"按钮
- 提供"查看完整日志"按钮（跳转到日志文件）
- 提供"查看错误堆栈"按钮（如果有 core dump）

**验收标准**：
- ✅ 错误提示在 5 秒内显示
- ✅ 错误提示友好（不显示技术栈错误）
- ✅ 提供清晰的恢复路径

---

### 6.3 日志刷太快，看不过来

**场景**：Agent 输出大量日志（如编译大项目），日志刷太快，用户看不过来

**降级方案**：
- 提供"暂停日志流"按钮（停止更新，方便查看）
- 提供"慢速模式"（限制刷新频率为每秒 10 行）
- 提供"只看错误"过滤按钮（只显示 ERROR 级别的日志）

**验收标准**：
- ✅ 降级方案不影响 Agent 的执行
- ✅ 暂停期间，新日志缓存在内存中，最多保留 1000 行
- ✅ 用户点击"继续"后，缓存的日志一次性显示

---

### 6.4 日志过多，搜索卡顿

**场景**：日志超过 1000 行，搜索响应时间超过 1 秒

**降级方案**：
- 显示"搜索中..."加载动画
- 提供"取消搜索"按钮
- 搜索超时（5 秒）后，显示"搜索超时，请缩小搜索范围"

**验收标准**：
- ✅ 搜索不会阻塞主线程（使用 Web Worker）
- ✅ 搜索超时后，不会崩溃，而是提示用户

---

### 6.5 Agent 无响应

**场景**：Agent 进程在运行，但没有输出日志（如死循环）

**错误提示**：显示"Agent 无响应，已超过 30 秒无输出"

**恢复路径**：
- 提供"重新启动"按钮
- 提供"强制杀死"按钮（发送 SIGKILL）
- 提供"查看进程状态"按钮（显示 CPU、内存使用情况）

**验收标准**：
- ✅ 错误提示在 30 秒后显示（避免误判）
- ✅ 提供"强制杀死"按钮，避免用户无法终止无响应的 Agent

---

### 6.6 日志格式错误

**场景**：Agent 输出的日志不符合 stream-json 格式

**降级方案**：
- 显示"日志格式错误，以纯文本模式显示"
- 将日志作为纯文本显示，不解析 JSON
- 提供报告错误的按钮（发送给开发团队）

**验收标准**：
- ✅ 降级方案不会崩溃，只是显示为纯文本
- ✅ 提示用户报告错误，帮助改进

---

## 7. 接口契约草案（Interface Contract Draft）

> **说明**：本章节用自然语言描述接口的业务字段含义和边界条件。

### 7.1 Rust → 前端：日志流推送

**触发时机**：Agent 输出日志

**请求结构**（Rust → 前端，通过 Tauri Event）：
```yaml
event_name: "agent:log_output"

payload:
  agent_id: "dave-1"
  logs:                                      # 日志列表（批量推送，提高性能）
    - timestamp: "2026-01-20T15:00:00Z"
      level: "INFO"                          # 日志级别：INFO / WARN / ERROR
      message: "> cargo test --lib"
      raw_output: "[INFO] > cargo test --lib"  # 原始输出（用于显示）
    - timestamp: "2026-01-20T15:00:01Z"
      level: "WARN"
      message: "warning: unused variable"
      raw_output: "[WARN] warning: unused variable"
  timestamp: "2026-01-20T15:00:01Z"
```

**边界条件**：
- **logs 为空**：不推送事件（避免冗余）
- **logs 超长**（> 100 条）：分批推送，每批最多 100 条
- **level 解析失败**：默认为 "INFO"

**性能要求**：
- 推送延迟 < 500ms（从 Agent 输出到前端收到）
- 批量推送间隔 < 1 秒（避免频繁推送）

---

### 7.2 前端 → Rust：清空日志

**触发时机**：用户点击"清空日志"按钮

**请求结构**（前端 → Rust，通过 Tauri Command）：
```yaml
command_name: "clear_agent_logs"

request:
  agent_id: "dave-1"

response:
  success: true
  error_message: null
```

**边界条件**：
- **Agent 不存在**：返回 `success: false, error_message: "Agent 不存在"`
- **Agent 未运行**：返回 `success: true`（幂等）

**性能要求**：
- 响应时间 < 300ms（从点击到清空完成）

---

### 7.3 前端 → Rust：搜索日志

**触发时机**：用户在搜索框中输入关键词

**请求结构**（前端 → Rust，通过 Tauri Command）：
```yaml
command_name: "search_agent_logs"

request:
  agent_id: "dave-1"
  keyword: "error"                            # 搜索关键词
  use_regex: false                            # 是否使用正则表达式

response:
  success: true
  matches:                                    # 匹配结果
    - line_number: 123
      timestamp: "2026-01-20T15:00:00Z"
      level: "ERROR"
      message: "error: test failed"
      preview: "[ERROR] error: test failed at line 123"  # 预览（用于高亮显示）
  total_matches: 5                            # 总匹配数
  error_message: null
```

**边界条件**：
- **keyword 为空**：返回 `matches: []`
- **keyword 超长**（> 100 字符）：返回 `success: false, error_message: "关键词过长"`
- **搜索超时**（5 秒）：返回 `success: false, error_message: "搜索超时"`

**性能要求**：
- 响应时间 < 1 秒（1000 行日志）

---

### 7.4 前端 → Rust：暂停/继续日志流

**触发时机**：用户点击"暂停日志流"或"继续日志流"按钮

**请求结构**（前端 → Rust，通过 Tauri Command）：
```yaml
command_name: "toggle_log_stream"

request:
  agent_id: "dave-1"
  paused: true                                # true=暂停，false=继续

response:
  success: true
  paused: true
  error_message: null
```

**边界条件**：
- **Agent 不存在**：返回 `success: false, error_message: "Agent 不存在"`
- **Agent 未运行**：返回 `success: true`（幂等）

**性能要求**：
- 响应时间 < 300ms（从点击到暂停/继续完成）

---

### 7.5 前端 → Rust：获取 Agent 进程状态

**触发时机**：用户点击"查看进程状态"按钮

**请求结构**（前端 → Rust，通过 Tauri Command）：
```yaml
command_name: "get_agent_process_status"

request:
  agent_id: "dave-1"

response:
  success: true
  process:
    process_id: 12345
    status: "RUNNING"                         # 进程状态：RUNNING / IDLE / CRASHED
    cpu_usage: 15.5                           # CPU 使用率（百分比）
    memory_usage: 1024000                     # 内存使用（字节）
    last_output_time: "2026-01-20T15:00:00Z"  # 最后输出时间
    is_responsive: true                       # 是否响应（30 秒内有输出）
  error_message: null
```

**边界条件**：
- **Agent 不存在**：返回 `success: false, error_message: "Agent 不存在"`
- **Agent 未运行**：返回 `process: null`
- **无法获取状态**：返回 `success: false, error_message: "无法获取进程状态"`

**性能要求**：
- 响应时间 < 500ms（从点击到显示状态）

---

### 7.6 Rust → 前端：Agent 崩溃推送

**触发时机**：Agent 进程异常退出（非用户主动终止）

**请求结构**（Rust → 前端，通过 Tauri Event）：
```yaml
event_name: "agent:crashed"

payload:
  agent_id: "dave-1"
  process_id: 12345
  exit_code: 1                                # 退出码（0=正常，非0=异常）
  error_message: "segmentation fault"         # 错误信息（如果有）
  timestamp: "2026-01-20T15:00:00Z"
```

**边界条件**：
- **退出码为 0**：不推送崩溃事件（正常退出）
- **error_message 为空**：返回 `error_message: null`

**性能要求**：
- 推送延迟 < 1 秒（从崩溃到前端收到）

---

## 8. UI 证据引用

### 8.1 原型链接

**可运行 HTML 原型**：`/docs/E-001-Agent-Console/prototypes/index.html`

### 8.2 关键页面截图

#### 运行终端面板

```
┌─────────────────────────────────────────────────────────┐
│  🟢 Dave-1 (后端开发)                                    │
│  正在执行: TASK-03                                       │
│  进度: [=========>     ] 60%                             │
├─────────────────────────────────────────────────────────┤
│  2026-01-20 15:00:00 [INFO]  > cargo test --lib        │
│  2026-01-20 15:00:01 [INFO]     Compiling...           │
│  2026-01-20 15:00:05 [WARN]     warning: unused...     │
│  2026-01-20 15:00:10 [ERROR]    error: test failed...  │
│                                                          │
│  [搜索日志...] [只看错误] [暂停] [清空]                   │
└─────────────────────────────────────────────────────────┘
```

#### 错误日志高亮

```
┌─────────────────────────────────────────────────────────┐
│  🔴 Agent 检测到错误                                      │
│                                                          │
│  [ERROR] error: test failed at line 123                 │
│                                                          │
│  [询问 Agent] [查看完整日志]                              │
└─────────────────────────────────────────────────────────┘
```

#### Agent 无响应提示

```
┌─────────────────────────────────────────────────────────┐
│  ⚠️  Agent 无响应                                         │
│                                                          │
│  Dave-1 已超过 30 秒无输出，可能已死循环                    │
│                                                          │
│  [重新启动] [强制杀死] [查看进程状态]                      │
└─────────────────────────────────────────────────────────┘
```

### 8.3 关键状态说明

#### 空态

- **运行终端**：显示"暂无活跃 Agent"提示，引导用户启动 Agent

#### 加载态

- **运行终端**：Agent 启动中，显示"正在启动..."动画

#### 失败态

- **运行终端**：Agent 崩溃时，显示"Agent 进程异常退出"错误信息，提供"重新启动"按钮

#### 成功态

- **运行终端**：显示实时日志流，日志级别用颜色标识，错误日志自动高亮

---

## 9. 依赖与备注

### 9.1 技术依赖

**前端技术栈**：
- React 18+ + TypeScript 5+
- Zustand（状态管理）
- xterm.js（终端模拟器）
- TailwindCSS + Shadcn/UI（UI 组件库）

**Rust 技术栈**：
- Tauri v2（桌面框架）
- std::process（进程管理）
- notify（文件监听）

**外部依赖**：
- Agent 进程：Claude Code（`claude -p --input-format=stream-json --output-format=stream-json --agent <agent>`）
- 日志格式：stream-json（流式 JSON）

---

### 9.2 STORY 依赖

**前置 STORY**：
- **STORY-001（全局状态可视化）**：依赖员工档案和 Agent 状态
- **STORY-002（任务调度闭环）**：依赖 Agent 启动和消息发送

**后续 STORY**：
- **STORY-004（自动资源管理）**：依赖本 STORY 的进程状态监听

---

### 9.3 数据依赖

**日志格式**（stream-json）：
```json
{"timestamp": "2026-01-20T15:00:00Z", "level": "INFO", "message": "> cargo test --lib"}
{"timestamp": "2026-01-20T15:00:01Z", "level": "WARN", "message": "warning: unused variable"}
{"timestamp": "2026-01-20T15:00:10Z", "level": "ERROR", "message": "error: test failed"}
```

**进程状态格式**：
```yaml
process_id: 12345
status: "RUNNING"
cpu_usage: 15.5
memory_usage: 1024000
last_output_time: "2026-01-20T15:00:00Z"
```

---

### 9.4 风险与未决项

**[OPEN-1] 日志存储策略**
- **问题**：日志是否需要持久化到磁盘？
- **建议**：Phase 1 先不持久化，只保留在内存中（最多 1000 行）。Phase 2 再考虑持久化到文件。
- **责任方**：prd + tech

**[OPEN-2] 日志搜索性能优化**
- **问题**：如果日志超过 10000 行，搜索会不会卡顿？
- **建议**：Phase 1 先限制最多保留 1000 行日志。Phase 2 再考虑索引优化。
- **责任方**：tech

**[OPEN-3] 终端模拟器选择**
- **问题**：xterm.js 是否满足需求？是否需要其他方案？
- **建议**：先验证 xterm.js 是否能满足需求（日志流、颜色高亮、搜索）。如果不行，再考虑其他方案。
- **责任方**：tech

---

### 9.5 非目标（Out of Scope）

本 STORY **不包含**：
- ❌ 日志持久化到磁盘：属于 Phase 2
- ❌ 日志分析（如自动提取错误模式）：属于 Phase 2
- ❌ 多窗口支持：属于 Phase 2
- ❌ 进程自动释放：属于 STORY-004

---

## 10. 验收总结

### 10.1 核心验收点

| 验收点 | 验收方式 | 目标值 |
|-------|---------|-------|
| **日志刷新延迟** | 计时测试 | < 1 秒 |
| **错误发现时间** | 计时测试 | < 10 秒（自动高亮） |
| **询问 Agent 时间** | 计时测试 | < 10 秒（一键询问） |
| **搜索响应时间** | 计时测试 | < 1 秒（1000 行） |
| **清空日志响应时间** | 计时测试 | < 300ms |

### 10.2 质量门槛

- ✅ 代码清晰：遵守 YAGNI 和 KISS 原则
- ✅ 测试覆盖率：核心业务逻辑 50%
- ✅ 能跑、不崩、能验证核心价值

### 10.3 用户体验北极星验证

**体验北极星**：从"盲目等待"到"实时掌控"

**验证方式**：
- ✅ 用户不需要频繁切终端，扫一眼屏幕即可
- ✅ 错误日志自动高亮，用户不会遗漏
- ✅ 一键询问 Agent，不需要复制粘贴
- ✅ 日志实时刷新，延迟 < 1 秒

---

## 11. 变更记录

| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|----------|
| v0.1 | 2026-01-20 | prd agent | 初版 STORY-003，基于 PRD 场景 3 |

---

## 附录：参考文档

- **PRD**：`/docs/E-001-Agent-Console/prd/PRD-E-001-v0.md`
- **Tech Baseline**：`/docs/_project/tech-baseline.md`
- **STORY-001**：`/docs/E-001-Agent-Console/story/STORY-001-全局状态可视化.md`
- **STORY-002**：`/docs/E-001-Agent-Console/story/STORY-002-任务调度闭环.md`
- **UI 原型**：`/docs/E-001-Agent-Console/prototypes/index.html`
